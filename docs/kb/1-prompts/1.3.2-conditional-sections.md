# 1.3.2 Prompt Templates: Conditional Sections & Control Flow

## Overview

Conditional sections enable prompts to adapt dynamically based on runtime context‚Äîuser permissions, environment (dev/prod), model capabilities, task complexity, or available resources. Instead of maintaining multiple prompt variants, you use control flow logic to include/exclude sections, adjust instructions, or modify behavior within a single template.

**Key Insight** (2024-2025): Production-grade prompts are context-aware, not one-size-fits-all. Conditional logic is essential for building adaptive AI agents.

**Current Date**: November 17, 2025

## Why Conditional Sections Matter

### Problem: Multiple Prompt Variants

**Without Conditionals** (manual variants):
```typescript
// Maintain separate prompts for each scenario
const promptDev = `You are an AI agent. DEBUG MODE ACTIVE...`;
const promptProd = `You are an AI agent. PRODUCTION MODE: Extra validation...`;
const promptReadOnly = `You are an AI agent. READ-ONLY MODE...`;
const promptAdmin = `You are an AI agent. ADMIN MODE: Full access...`;

// Complex selection logic
let prompt;
if (env === 'production') {
  if (user.isAdmin) {
    prompt = promptAdmin;
  } else if (user.isReadOnly) {
    prompt = promptReadOnly;
  } else {
    prompt = promptProd;
  }
} else {
  prompt = promptDev;
}
```

**Problems**:
- ‚ùå Duplication (core instructions repeated)
- ‚ùå Hard to maintain (update one, miss others)
- ‚ùå Combinatorial explosion (N permissions √ó M environments)
- ‚ùå No reusability

**With Conditionals** (single adaptive template):
```handlebars
You are an AI agent specialized in content management.

{{#if isDevelopment}}
**DEBUG MODE:** Verbose logging enabled.
{{else}}
**PRODUCTION MODE:** Extra validation required.
{{/if}}

{{#if user.isAdmin}}
**ADMIN ACCESS:** Full capabilities including:
- Delete operations
- Bulk modifications
- System configuration
{{else if user.canWrite}}
**WRITE ACCESS:** Standard capabilities including:
- Create pages
- Update content
- Delete own content (requires confirmation)
{{else}}
**READ-ONLY ACCESS:** Limited to:
- View content
- Search operations
{{/if}}

{{#if hasWorkingMemory}}
**WORKING MEMORY:**
{{{workingMemory}}}
{{/if}}
```

**Benefits**:
- ‚úÖ Single source of truth
- ‚úÖ Easy to maintain
- ‚úÖ Scales to complex logic
- ‚úÖ Context-aware behavior

## Conditional Patterns

### Pattern 1: Environment-Based Instructions

**Adapt behavior for dev/staging/production**:

**Handlebars**:
```handlebars
You are an autonomous AI assistant.

{{#if environment "production"}}
**PRODUCTION MODE:**
- Extra validation enabled for all operations
- Audit logging active
- Rate limiting: 100 requests/minute
- Fail-safe: Always ask before destructive operations
{{else if environment "staging"}}
**STAGING MODE:**
- Validation enabled
- Test data: Safe to experiment
- Rate limiting: 1000 requests/minute
{{else}}
**DEVELOPMENT MODE:**
- Debug logging enabled
- No rate limiting
- Experimental features available
{{/if}}
```

**Jinja2**:
```jinja2
You are an autonomous AI assistant.

{% if environment == "production" %}
**PRODUCTION MODE:**
- Extra validation enabled for all operations
- Audit logging active
- Rate limiting: 100 requests/minute
{% elif environment == "staging" %}
**STAGING MODE:**
- Validation enabled
- Test data: Safe to experiment
{% else %}
**DEVELOPMENT MODE:**
- Debug logging enabled
- No rate limiting
{% endif %}
```

**Your Codebase Enhancement**:
```typescript
// server/prompts/react.hbs
{{#if (eq environment "production")}}
**PRODUCTION MODE:**
- Validate all destructive operations twice
- Log all tool calls for audit
- Enable conservative error handling
{{else}}
**DEVELOPMENT MODE:**
- Verbose debugging enabled
- Stack traces included in errors
{{/if}}
```

### Pattern 2: Permission-Based Capabilities

**Show only tools/features user can access**:

```handlebars
**AVAILABLE CAPABILITIES:**

{{#if permissions.canRead}}
- **READ:** View pages, sections, collections
{{/if}}

{{#if permissions.canWrite}}
- **WRITE:** Create and update content
{{/if}}

{{#if permissions.canDelete}}
- **DELETE:** Remove content (requires confirmation)
{{/if}}

{{#if permissions.canAdmin}}
- **ADMIN:** Manage users, configure system
{{/if}}

{{#unless permissions.canWrite}}
**NOTE:** You have read-only access. Suggest edits but cannot execute write operations.
{{/unless}}

**TOOLS:** {{tools.length}} available
{{#each tools}}
{{#if (hasPermission @root.permissions this.requiredPermission)}}
- {{name}}: {{description}}
{{/if}}
{{/each}}
```

**Benefit**: Prompts automatically reflect user's actual capabilities

### Pattern 3: Model-Based Instructions

**Adapt instructions to model capabilities**:

```handlebars
You are an AI assistant powered by {{modelName}}.

{{#if (eq modelFamily "o1")}}
**REASONING MODEL ACTIVE:**
- You have extended thinking time for complex problems
- Break down tasks into reasoning steps
- Show your chain-of-thought naturally
- No need for explicit "think step-by-step" prompts
{{else if (eq modelFamily "gpt-4")}}
**STANDARD MODEL:**
- Use chain-of-thought prompting for complex tasks
- Think step-by-step when needed
- Balance speed and accuracy
{{else}}
**FAST MODEL:**
- Prioritize speed over deep reasoning
- Use for simple, well-defined tasks
- Escalate complex problems to more capable models
{{/if}}

{{#if supportsStructuredOutputs}}
**STRUCTURED OUTPUTS ENABLED:**
All tool calls will use JSON Schema validation.
{{/if}}

{{#if supportsFunctionCalling}}
**FUNCTION CALLING AVAILABLE:**
Use native function calling for tool execution.
{{else}}
**TEXT-BASED TOOLS:**
Format tool calls as: Action: [tool_name]
Action Input: [parameters]
{{/if}}
```

### Pattern 4: Task Complexity Adaptation

**Adjust guidance based on task difficulty**:

```handlebars
TASK: {{task}}

{{#if (gt taskComplexity 7)}}
**HIGH COMPLEXITY TASK:**
1. Break down into sub-tasks
2. Execute incrementally
3. Validate each step before proceeding
4. Expect multiple rounds of tool usage
5. Synthesize results at the end

**SUGGESTED APPROACH:**
- Plan: List all required information/actions
- Execute: One tool at a time, observe results
- Adapt: Adjust plan based on observations
- Verify: Double-check critical results
{{else if (gt taskComplexity 4)}}
**MODERATE COMPLEXITY:**
- Think through the approach first
- Use 2-3 tool calls to gather information
- Provide clear, structured response
{{else}}
**SIMPLE TASK:**
- Execute directly
- Minimal explanation needed
- Quick, focused response
{{/if}}
```

### Pattern 5: Context-Aware Examples

**Show relevant examples based on task type**:

```handlebars
**EXAMPLES:**

{{#if (eq taskType "search")}}
**EXAMPLE - Search Task:**
User: Find pages about React
Thought: I need to use the fuzzy search tool
Action: searchResources
Action Input: { "query": "React", "type": "page" }
Observation: Found 3 pages: [list]
Response: I found 3 pages about React: [summarized results]
{{/if}}

{{#if (eq taskType "creation")}}
**EXAMPLE - Creation Task:**
User: Create a new page titled "Getting Started"
Thought: I need to check if slug exists, then create
Action: getPage
Action Input: { "slug": "getting-started", "fetchMode": "lightweight" }
Observation: Error: Page not found
Thought: Slug is available, I can create the page
Action: createPage
Action Input: { "title": "Getting Started", "slug": "getting-started", "content": "..." }
Observation: Page created successfully
{{/if}}

{{#if (eq taskType "analysis")}}
**EXAMPLE - Analysis Task:**
User: Analyze traffic trends
Thought: I need to gather data, then analyze patterns
[Multi-step example with data gathering and analysis]
{{/if}}
```

### Pattern 6: Conditional Rules

**Apply rules based on operation type**:

```handlebars
**RULES:**

1. THINK before acting - explain your reasoning
2. EXECUTE immediately - don't ask unnecessary questions

{{#if (includes destructiveOps currentOperation)}}
3. **DESTRUCTIVE OPERATION DETECTED:**
   - NEVER auto-confirm deletions
   - ALWAYS describe what will be deleted
   - WAIT for explicit user confirmation
   - Double-check the operation after confirmation
{{/if}}

{{#if (includes highValueOps currentOperation)}}
4. **HIGH-VALUE OPERATION:**
   - Validate all inputs carefully
   - Preview the result before executing
   - Provide detailed explanation of changes
{{/if}}

{{#if user.isNewUser}}
5. **NEW USER ASSISTANCE:**
   - Explain what you're doing
   - Suggest best practices
   - Offer tips for future use
{{/if}}
```

### Pattern 7: Dynamic Tool Filtering

**Show only relevant tools for current context**:

```handlebars
**AVAILABLE TOOLS:** {{relevantToolCount}} tools

{{#each tools}}
{{#if (or 
  (not @root.filterByContext)
  (includes @root.taskContext this.contexts)
)}}
- **{{name}}**: {{description}}
  {{#if this.requiresConfirmation}}
  ‚ö†Ô∏è Requires user confirmation
  {{/if}}
  {{#if this.isExperimental}}
  üß™ Experimental - use with caution
  {{/if}}
{{/if}}
{{/each}}

{{#if filterByContext}}
**NOTE:** Only tools relevant to "{{taskContext}}" are shown. Use searchTools to find others.
{{/if}}
```

### Pattern 8: Graceful Degradation

**Handle missing context gracefully**:

```handlebars
{{#if workingMemory}}
**WORKING MEMORY:**
{{{workingMemory}}}
{{else}}
**FRESH SESSION:** No prior context available. Ask clarifying questions if needed.
{{/if}}

{{#if userPreferences}}
**USER PREFERENCES:**
- Language: {{userPreferences.language}}
- Verbosity: {{userPreferences.verbosity}}
- Format: {{userPreferences.outputFormat}}
{{else}}
**DEFAULT PREFERENCES:** Using standard English, moderate verbosity, markdown format.
{{/if}}

{{#if (gt tools.length 0)}}
**TOOLS AVAILABLE:** {{tools.length}} tools
{{toolsFormatted}}
{{else}}
**NO TOOLS:** You can only provide informational responses based on your training.
{{/if}}
```

## Advanced Control Flow

### Nested Conditionals

**Complex decision trees**:

```handlebars
{{#if user.isAuthenticated}}
  {{#if user.isAdmin}}
    **ADMIN PANEL ACCESS:** Full system control
  {{else if user.isPremium}}
    {{#if user.trialExpired}}
      **TRIAL EXPIRED:** Upgrade to continue using premium features
    {{else}}
      **PREMIUM ACCESS:** Advanced features enabled
    {{/if}}
  {{else}}
    **STANDARD ACCESS:** Basic features available
  {{/if}}
{{else}}
  **GUEST MODE:** Limited access. Login for full features.
{{/if}}
```

### Combined Conditions

**Multiple conditions with AND/OR logic**:

**Handlebars** (custom helpers):
```typescript
Handlebars.registerHelper('and', (a, b) => a && b);
Handlebars.registerHelper('or', (a, b) => a || b);
Handlebars.registerHelper('not', (a) => !a);
```

```handlebars
{{#if (and user.isAuthenticated (not user.isReadOnly))}}
**WRITE ACCESS ENABLED**
{{/if}}

{{#if (or user.isAdmin user.isModerator)}}
**MODERATION TOOLS AVAILABLE**
{{/if}}

{{#if (and (eq environment "production") user.isAdmin)}}
**PRODUCTION ADMIN MODE:** Extreme caution required
{{/if}}
```

**Jinja2** (native support):
```jinja2
{% if user.is_authenticated and not user.is_read_only %}
**WRITE ACCESS ENABLED**
{% endif %}

{% if user.is_admin or user.is_moderator %}
**MODERATION TOOLS AVAILABLE**
{% endif %}
```

### Switch-Case Pattern

**Multiple exclusive conditions**:

**Handlebars** (chained if-else):
```handlebars
{{#if (eq userTier "enterprise")}}
  **ENTERPRISE TIER:** Unlimited access, dedicated support
{{else if (eq userTier "premium")}}
  **PREMIUM TIER:** Advanced features, priority support
{{else if (eq userTier "standard")}}
  **STANDARD TIER:** Core features included
{{else}}
  **FREE TIER:** Basic features only
{{/if}}
```

**Jinja2**:
```jinja2
{% if user_tier == "enterprise" %}
  **ENTERPRISE TIER:** Unlimited access
{% elif user_tier == "premium" %}
  **PREMIUM TIER:** Advanced features
{% elif user_tier == "standard" %}
  **STANDARD TIER:** Core features
{% else %}
  **FREE TIER:** Basic features
{% endif %}
```

### Loop with Conditionals

**Filter items during iteration**:

```handlebars
**YOUR RECENT PAGES:**
{{#each recentPages}}
  {{#if this.published}}
  - ‚úÖ {{title}} (published {{publishedDate}})
  {{else}}
  - üìù {{title}} (draft)
  {{/if}}
{{/each}}

**AVAILABLE ACTIONS:**
{{#each tools}}
  {{#unless this.requiresAdminPermission}}
    {{#if (or @root.user.canWrite (eq this.type "read"))}}
    - {{name}}: {{description}}
    {{/if}}
  {{/unless}}
{{/each}}
```

## Production Implementation

### TypeScript with Custom Helpers

```typescript
// prompts/helpers.ts
import Handlebars from 'handlebars';

// Comparison helpers
Handlebars.registerHelper('eq', (a, b) => a === b);
Handlebars.registerHelper('ne', (a, b) => a !== b);
Handlebars.registerHelper('gt', (a, b) => a > b);
Handlebars.registerHelper('gte', (a, b) => a >= b);
Handlebars.registerHelper('lt', (a, b) => a < b);
Handlebars.registerHelper('lte', (a, b) => a <= b);

// Logical helpers
Handlebars.registerHelper('and', (a, b) => a && b);
Handlebars.registerHelper('or', (a, b) => a || b);
Handlebars.registerHelper('not', (a) => !a);

// Utility helpers
Handlebars.registerHelper('includes', (array, item) => 
  Array.isArray(array) && array.includes(item)
);

Handlebars.registerHelper('hasPermission', (userPerms, requiredPerm) => {
  if (!requiredPerm) return true;
  return userPerms && userPerms.includes(requiredPerm);
});

Handlebars.registerHelper('isProduction', () => 
  process.env.NODE_ENV === 'production'
);

Handlebars.registerHelper('default', (value, defaultValue) => 
  value !== undefined ? value : defaultValue
);

// Usage in templates
// {{#if (eq environment "production")}}...{{/if}}
// {{#if (and user.isAuth (not user.isReadOnly))}}...{{/if}}
// {{#if (hasPermission user.permissions "delete")}}...{{/if}}
```

### Context Builder

```typescript
// prompts/context-builder.ts
interface PromptContext {
  environment: 'development' | 'staging' | 'production';
  user: {
    id: string;
    permissions: string[];
    isAdmin: boolean;
    isReadOnly: boolean;
    isNewUser: boolean;
  };
  task: {
    type: 'search' | 'creation' | 'update' | 'deletion' | 'analysis';
    complexity: number; // 1-10
  };
  model: {
    name: string;
    family: 'gpt-4' | 'o1' | 'claude' | 'other';
    supportsStructuredOutputs: boolean;
    supportsFunctionCalling: boolean;
  };
  tools: Tool[];
  workingMemory?: string;
}

export class PromptContextBuilder {
  private context: Partial<PromptContext> = {};
  
  setEnvironment(env: string) {
    this.context.environment = env as any;
    return this;
  }
  
  setUser(user: any) {
    this.context.user = {
      id: user.id,
      permissions: user.permissions || [],
      isAdmin: user.permissions?.includes('admin') || false,
      isReadOnly: !user.permissions?.includes('write'),
      isNewUser: user.createdAt > Date.now() - 7 * 24 * 60 * 60 * 1000
    };
    return this;
  }
  
  setTask(type: string, complexity?: number) {
    this.context.task = {
      type: type as any,
      complexity: complexity || 5
    };
    return this;
  }
  
  setModel(modelConfig: any) {
    this.context.model = {
      name: modelConfig.name,
      family: this.inferFamily(modelConfig.name),
      supportsStructuredOutputs: modelConfig.structuredOutputs || false,
      supportsFunctionCalling: modelConfig.functionCalling || false
    };
    return this;
  }
  
  setTools(tools: Tool[]) {
    this.context.tools = tools;
    return this;
  }
  
  setWorkingMemory(memory: string) {
    this.context.workingMemory = memory;
    return this;
  }
  
  private inferFamily(modelName: string): string {
    if (modelName.includes('o1') || modelName.includes('o3')) return 'o1';
    if (modelName.includes('gpt')) return 'gpt-4';
    if (modelName.includes('claude')) return 'claude';
    return 'other';
  }
  
  build(): PromptContext {
    return this.context as PromptContext;
  }
}

// Usage
const context = new PromptContextBuilder()
  .setEnvironment(process.env.NODE_ENV)
  .setUser(currentUser)
  .setTask('creation', 6)
  .setModel(modelConfig)
  .setTools(availableTools)
  .setWorkingMemory(workingMemory.serialize())
  .build();

const prompt = templateEngine.render('react', context);
```

### Dynamic Template Selection

```typescript
// prompts/template-selector.ts
export class TemplateSelector {
  selectTemplate(context: PromptContext): string {
    // Select base template
    let templateName = 'react-base';
    
    // Augment based on context
    if (context.user.isNewUser) {
      templateName += '-with-tutorial';
    }
    
    if (context.task.complexity > 7) {
      templateName += '-complex';
    }
    
    if (context.environment === 'production') {
      templateName += '-prod';
    }
    
    return templateName;
  }
  
  // Alternative: Single template with rich conditionals
  buildPrompt(context: PromptContext): string {
    return templateEngine.render('react-adaptive', {
      ...context,
      // Add computed flags
      isComplexTask: context.task.complexity > 7,
      showTutorial: context.user.isNewUser,
      isProduction: context.environment === 'production',
      destructiveOps: ['deletePage', 'bulkDelete', 'resetDatabase'],
      highValueOps: ['createPage', 'updatePage', 'publishPage']
    });
  }
}
```

## Testing Conditional Logic

```typescript
// tests/prompt-conditionals.test.ts
import { describe, test, expect } from 'vitest';

describe('Prompt Conditionals', () => {
  test('should show production warnings in prod env', () => {
    const context = { environment: 'production', user: { isAdmin: false } };
    const prompt = templateEngine.render('react', context);
    
    expect(prompt).toContain('PRODUCTION MODE');
    expect(prompt).toContain('Extra validation');
  });
  
  test('should hide admin tools for non-admin users', () => {
    const context = { 
      user: { isAdmin: false, permissions: ['read', 'write'] },
      tools: [
        { name: 'getPage', requiredPermission: 'read' },
        { name: 'configureSystem', requiredPermission: 'admin' }
      ]
    };
    
    const prompt = templateEngine.render('react', context);
    
    expect(prompt).toContain('getPage');
    expect(prompt).not.toContain('configureSystem');
  });
  
  test('should show task-specific examples', () => {
    const context = { task: { type: 'search' } };
    const prompt = templateEngine.render('react', context);
    
    expect(prompt).toContain('EXAMPLE - Search Task');
    expect(prompt).not.toContain('EXAMPLE - Creation Task');
  });
  
  test('should adapt to model capabilities', () => {
    const context = {
      model: {
        family: 'o1',
        supportsStructuredOutputs: true
      }
    };
    
    const prompt = templateEngine.render('react', context);
    
    expect(prompt).toContain('REASONING MODEL ACTIVE');
    expect(prompt).toContain('STRUCTURED OUTPUTS ENABLED');
  });
});
```

## Key Takeaways

**What are Conditional Sections**:
- Dynamic prompt segments that appear/hide based on context
- Enable single adaptive template instead of multiple variants
- Control flow: if/else, loops, switches

**Why They Matter** (2024-2025):
- **Adaptability**: One prompt adapts to many contexts
- **Maintainability**: Single source of truth
- **Scalability**: Handles complex permission/environment logic
- **User Experience**: Relevant instructions for each user

**Common Patterns**:
1. **Environment**: Dev/staging/prod behavior
2. **Permissions**: Show only accessible capabilities
3. **Model**: Adapt to model capabilities
4. **Task Complexity**: Adjust guidance depth
5. **Context-Aware Examples**: Relevant demonstrations
6. **Conditional Rules**: Apply rules when needed
7. **Tool Filtering**: Show only relevant tools
8. **Graceful Degradation**: Handle missing data

**Implementation**:
```typescript
// 1. Register helpers
registerConditionalHelpers(Handlebars);

// 2. Build rich context
const context = new PromptContextBuilder()
  .setEnvironment(env)
  .setUser(user)
  .setTask(taskType, complexity)
  .build();

// 3. Render adaptive prompt
const prompt = templateEngine.render('react', context);
```

**Your Codebase Enhancement**:
```handlebars
{{#if (eq environment "production")}}
**PRODUCTION MODE:** Extra validation required
{{/if}}

{{#if user.canDelete}}
**DELETE CAPABILITY:** Available (requires confirmation)
{{else}}
**READ-ONLY:** Cannot perform destructive operations
{{/if}}
```

## Navigation

- [‚Üê Previous: 1.3.1 Template Engines & Variable Injection](./1.3.1-template-engines.md)
- [‚Üë Back to Knowledge Base TOC](../../AI_KNOWLEDGE_BASE_TOC.md)
- [‚Üí Next: 1.3.3 Prompt Versioning & Caching](./1.3.3-versioning-caching.md)

---

*Part of Layer 1: Prompt Engineering - Context-aware adaptive prompts*
